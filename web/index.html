
<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>goconvert web</title>
</head>
<body>
	<h1>Viewing index</h1>

	<div>Testing page, port {{.WebPort |html}}</div>

	<h1>Image conversion and upload tool</h1>
	<section id="imagefolder">
		<label for="folder">Image folder</label> <input id="folder"
			name="folder" type="text" value="." />
	</section>
	<section id="collectionname">
		<label for="collection">Collection name</label> <input id="collection"
			name="collection" type="text" value="" />
		<p>
			<input type="button" id="compress" value="compress images" />
		</p>
	</section>
	<section id="logsection">
		<span>Output log</span>
		<div id="log">
		
		</div>
	</section>
	<section id="errorsection">
		<span>Error log</span>
		<div id="errors" style="color:maroon;font-weight: bold;">
		
		</div>
	</section>
	<!-- 
<script src="http://www.google.com/jsapi"></script>
<script>google.load("jquery", "1.3")</script>
<script src="http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js"></script>
<script src="http://jquery-websocket.googlecode.com/files/jquery.websocket-0.0.1.js"></script>
 -->
	<script type="text/javascript" src="scripts/jquery-1.7.js"></script>
	<script>
	
		$(function(){
			var pollHandler = function(op, poll_interval_msec, timeout_msec){
				t = 0;
				var doPoll = function(){
				    $.ajax('/' + op +'/status', {
							data: null,
							type: "POST",
							dataType: "json",
							beforeSend: function(x) {
					            if (x && x.overrideMimeType) {
					              x.overrideMimeType("application/j-son;charset=UTF-8");
					            }
					        },
							success: function(data) {
						        //alert(data);  // process results here
						        if (timeout_msec <0 || t < timeout_msec) {
						        	writeLog(data.output);
						        	t += poll_interval_msec;
						        	setTimeout(doPoll,poll_interval_msec);
						        } else {
									alert('timed out');					        	
						        }
							},
							error: function() {
								alert('error');
							}
						});
					};
					
				return doPoll;
			};
		
		/*
			 var ws = $.websocket("ws://127.0.0.1:{{.WebPort |html}}/echo", {
			 events: {
			 message: function(e) { $('#content').append(e.data + '<br>') }
			 }
			 });
			 */
			
			$('#compress').click(function() {
				var data = {folder: $("#folder").val(), collection: $("#collection").val()};	
				$.ajax("/compress", {
					data:  JSON.stringify(data),
					type: "POST",
					dataType: "json",
					beforeSend: function(x) {
			            if (x && x.overrideMimeType) {
			              x.overrideMimeType("application/j-son;charset=UTF-8");
			            }
			        },
					success: function(data) {
						if (!data) {
							return;
						}
						if (data.compile_errors != "") {
							//setOutput(data.compile_errors, true);
							highlightErrors(data.compile_errors);
							return;
						}
						pollfunc = pollHandler("compress", 1000, 5000);
						writeLog(data.output);
						pollfunc();
					},
					error: function() {
						alert('error');
					}
				});
			});
			
			var logdiv = $('#log');
			var errordiv = $('#errors');
			var writeLog = function(msg){
				logdiv.append('<p>' + msg + '</p>');
			}
			var highlightErrors = function(msg){
				errordiv.append('<p>' + msg + '</p>');
			}
		});
	</script>
</body>
</html>

